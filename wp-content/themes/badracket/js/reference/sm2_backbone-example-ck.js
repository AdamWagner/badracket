// Generated by CoffeeScript 1.4.0
var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);r.prototype=t.prototype;e.prototype=new r;e.__super__=t.prototype;return e};(function(e,t){return typeof define=="function"&&define.amd?define(["backbone","underscore"],function(n,r){return e.Backbone.SM2=t(n,r)}):typeof require=="function"&&(typeof module!=="undefined"&&module!==null?module.exports:void 0)!=null?module.exports=t(require("backbone"),require("underscore")):e.Backbone.SM2=t(e.Backbone,e._)})(this,function(e,t){var n,r,i,s;s=function(){function e(e){this.queue=e;this.ref=-1}e.prototype.cur=function(){return t.isArray(this.ref)?this.queue.at(this.ref[0]).get("tracks").at(this.ref[1]):this.queue.at(this.ref)};e.prototype.peek=function(){return this.nextImpl().track};e.prototype.find=function(e){var t,n,r;r=this.findImpl(e),n=r.track,t=r.ref;this.ref=t;return n};e.prototype.next=function(){var e,t,n;n=this.nextImpl(),t=n.track,e=n.ref;this.ref=e;return t};e.prototype.prev=function(){var e,t,n;n=this.prevImpl(),t=n.track,e=n.ref;this.ref=e;return t};e.prototype.findImpl=function(e){var t,n,r,i,s,o,u,a,f,l;f=this.queue.models;for(t=s=0,u=f.length;s<u;t=++s){r=f[t];if(r.get("tracks")){l=r.get("tracks").models;for(n=o=0,a=l.length;o<a;n=++o){i=l[n];if(i.id===e||i.cid===e)return{track:i,ref:[t,n]}}}else if(r.id===e||r.cid===e)return{track:r,ref:t}}return{track:void 0,ref:this.ref}};e.prototype.prevImpl=function(){var e,n;if(t.isArray(this.ref)){e=this.ref.slice();n=this.queue.at(e[0]).get("tracks").at(e[1]-1);if(n)e[1]=e[1]-1;else{n=this.queue.at(e[0]-1);e=e[0]-1}}else{e=this.ref-1;n=this.queue.at(e)}if(!n)return{ref:-1,track:n};if(n.get("tracks")){e=[e,n.get("tracks").length-1];n=n.get("tracks").last()}return{ref:e,track:n}};e.prototype.nextImpl=function(){var e,n;if(t.isArray(this.ref)){e=this.ref.slice();n=this.queue.at(e[0]).get("tracks").at(e[1]+1);if(n)e[1]=e[1]+1;else{n=this.queue.at(e[0]+1);e=e[0]+1}}else{e=this.ref+1;n=this.queue.at(e)}if(!n)return{ref:this.ref,track:this.cur()};if(n.get("tracks")){e=[e,0];n=n.get("tracks").at(0)}return{ref:e,track:n}};return e}();n=function(){function n(t){this.allowPreload=t!=null?t.allowPreload:void 0;this.preloadThreshold=(t!=null?t.preloadThreshold:void 0)||this.preloadThreshold;this.sound=void 0;this.nextSound=void 0;this.queue=new e.Collection;this.cur=new s(this.queue)}t.extend(n.prototype,e.Events);n.prototype.preloadThreshold=5e3;n.prototype.add=function(n){n=t.isArray(n)?new e.Model({tracks:new e.Collection(n)}):n instanceof e.Collection?new e.Model({tracks:n}):n instanceof e.Model?n:new e.Model(n);this.queue.add(n);return this.trigger("queue:add",n)};n.prototype.isActive=function(e,t){var n,r,i;t==null&&(t=0);return e?((n=this.sound)!=null?n.playState:void 0)===t&&((r=this.sound)!=null?r.id:void 0)===e.id:((i=this.sound)!=null?i.playState:void 0)===t};n.prototype.isPlaying=function(e){var t;return this.isActive(e,1)&&((t=this.sound)!=null?!t.paused:!void 0)};n.prototype.isPaused=function(e){var t;return this.isActive(e,1)&&((t=this.sound)!=null?t.paused:void 0)};n.prototype.play=function(e){var t;if(e){t=this.cur.find(e);if(!t)return;this.sound=this.initPlayable(t);this.initSound(this.sound);this.sound&&this.trigger("queue:select",this.sound.track,this.sound);return this.sound}if(this.isPlaying())return;if(this.sound!=null){this.sound.play();this.trigger("track:play",this.sound.track,this.sound)}else{t=this.cur.next();if(!t){this.trigger("queue:end");return}this.sound=this.initPlayable(t);this.initSound(this.sound)}return this.sound};n.prototype.pause=function(){if(this.sound==null)return;this.sound.pause();return this.trigger("track:pause",this.sound.track,this.sound)};n.prototype.stop=function(e){e==null&&(e=!1);if(this.sound==null)return;this.sound.stop();this.trigger("track:stop",this.sound.track,this.sound);if(e){this.sound.destruct();return this.sound=void 0}};n.prototype.next=function(){if(this.sound==null)return;this.stop(!0);if(this.nextSound!=null){this.sound=this.nextSound;this.initSound(this.sound);this.cur.next()}else this.play();this.sound&&this.trigger("queue:next",this.sound.track,this.sound);return this.sound};n.prototype.prev=function(){var e;if(this.sound==null)return;this.stop(!0);e=this.cur.prev();if(!e)return;this.sound=this.initPlayable(e);this.initSound(this.sound);this.sound&&this.trigger("queue:prev",this.sound.track,this.sound);return this.sound};n.prototype.initPlayable=function(e,n){var r,i=this;n==null&&(n=!1);r=soundManager.createSound({onid3:function(){return i.trigger("track:id3loaded",e,r.id3)},onload:function(){return i.preloadNextFor(r)},onfinish:function(){i.trigger("track:finish",i.sound.track,i.sound);return i.next()},id:e.get("id"),url:t.isFunction(e.url)?e.url():e.get("url"),whileplaying:function(){return i.trigger("track:whileplaying",e,r)},whileloading:function(){return i.trigger("track:whileloading",e,r)}});r.track=e;return r};n.prototype.initSound=function(e){this.sound=e;this.nextSound=void 0;this.trigger("track:play",this.sound.track,this.sound);return this.sound.play()};n.prototype.preloadNextFor=function(e){var t,n=this;if(this.allowPreload!=null){t=e.duration-this.preloadThreshold;return e.onPosition(t,function(){var r;e.clearOnPosition(t);r=n.cur.peek();n.nextSound=n.initPlayable(r);return n.nextSound.load()})}};return n}();r=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}__extends(t,e);t.prototype.className="app";t.prototype.initialize=function(e){this.player=(e!=null?e.player:void 0)||new n;this.onPlay&&this.listenTo(this.player,"track:play",this.onPlay);this.onStop&&this.listenTo(this.player,"track:stop",this.onStop);this.onPause&&this.listenTo(this.player,"track:pause",this.onPause);this.onQueueAdd&&this.listenTo(this.player,"queue:add",this.onQueueAdd);if(this.onTrackInfoReceived)return this.listenTo(this.player,"track:id3loaded",this.onTrackInfoReceived)};return t}(e.View);i=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}__extends(t,e);t.prototype.className="view-progress-bar";t.prototype.events={click:"onClick"};t.prototype.initialize=function(e){this.$progressBar=void 0;this.$bufferingBar=void 0;this.trackId=void 0;this.player=e.player;return this.listenTo(this.player,{"track:play":this.onPlay,"track:stop":this.onStop,"track:whileplaying":this.whilePlaying,"track:whileloading":this.whileLoading})};t.prototype.render=function(){this.$el.html('<div class="buffering-bar"></div>\n<div class="progress-bar"></div>');return this.updateElements()};t.prototype.updateElements=function(){this.$progressBar=this.$(".progress-bar");return this.$bufferingBar=this.$(".buffering-bar")};t.prototype.onClick=function(e){var t;if(this.trackId==null||this.player.sound==null)return;t=e.offsetX/this.$el.width()*this.player.sound.duration;return this.player.sound.setPosition(t)};t.prototype.onPlay=function(e){return this.trackId=e.id};t.prototype.onStop=function(){this.trackId=void 0;return this.$progressBar.width(0)};t.prototype.whilePlaying=function(e,t){var n,r;if(e.id===this.trackId){n=this.$el.width();r=t.position/t.duration*n;return this.$progressBar.width(Math.min(r,n))}};t.prototype.whileLoading=function(e,t){var n,r;if(e.id===this.trackId){n=this.$el.width();r=t.bytesLoaded/t.bytesTotal*n;return this.$bufferingBar.width(Math.min(r,n))}};return t}(e.View);return{Player:n,PlayerView:r,ProgressBar:i}});