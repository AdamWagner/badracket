function render_page(e,t){e.facebook.app(function(n){e.facebook.me(function(r){t.render("index.ejs",{layout:!1,req:e,app:n,user:r})})})}function handle_facebook_request(e,t){e.facebook.token?async.parallel([function(t){e.facebook.get("/me/friends",{limit:4},function(n){e.friends=n;t()})},function(t){e.facebook.get("/me/photos",{limit:16},function(n){e.photos=n;t()})},function(t){e.facebook.get("/me/likes",{limit:4},function(n){e.likes=n;t()})},function(t){e.facebook.fql("SELECT uid, name, is_app_user, pic_square FROM user WHERE uid in (SELECT uid2 FROM friend WHERE uid1 = me()) AND is_app_user = 1",function(n){e.friends_using_app=n;t()})}],function(){render_page(e,t)}):render_page(e,t)}var async=require("async"),express=require("express"),util=require("util"),app=express.createServer(express.logger(),express.static(__dirname+"/public"),express.bodyParser(),express.cookieParser(),express.session({secret:process.env.SESSION_SECRET||"secret123"}),require("faceplate").middleware({app_id:process.env.FACEBOOK_APP_ID,secret:process.env.FACEBOOK_SECRET,scope:"user_likes,user_photos,user_photo_video_tags"})),port=process.env.PORT||3e3;app.listen(port,function(){console.log("Listening on "+port)});app.dynamicHelpers({host:function(e,t){return e.headers.host},scheme:function(e,t){return e.headers["x-forwarded-proto"]||"http"},url:function(e,t){return function(n){return app.dynamicViewHelpers.scheme(e,t)+app.dynamicViewHelpers.url_no_scheme(e,t)(n)}},url_no_scheme:function(e,t){return function(n){return"://"+app.dynamicViewHelpers.host(e,t)+(n||"")}}});app.get("/",handle_facebook_request);app.post("/",handle_facebook_request);