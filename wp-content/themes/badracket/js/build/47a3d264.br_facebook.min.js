var br_fb=function(){function a(b){window.FB&&(i.accessToken||i.appAccess)?b&&b():(console.log("ensure init still running"),i.loginCounter++,i.loginCounter<50&&setTimeout(function(){a(b)},150))}function b(a){null!==br_fb.user.events?a():$(window).on("fb-user-data-load",function(){a()})}function c(a){br_fb.BR.events.length>0?a():$(window).on("fb-page-data-load",function(){a()})}function d(b){var c=new $.Deferred,d=function(){"connected"===i.connectStatus?(FB.api(b,function(a){c.resolve(a)}),console.log("call fb called with this path "+b)):(b=b+"&access_token="+escape(i.appAccess),console.log("call fb called with this path "+b),FB.api(b,function(a){console.log(a),c.resolve(a)}))};return a(d),c.promise()}function e(){FB.getLoginStatus(function(a){n.globalSetup(a)})}function f(a){FB.login(function(b){e(b),a&&a()},{scope:l.join(",")})}function g(){FB.logout(function(){})}function h(){FB.init({appId:i.appId,channelUrl:"//WWW.BADRACKET.COM/channel.html",status:!0,cookie:!0,xfbml:!0}),e()}var i={appId:"prod"===BR_ENV?"182655285084916":"500547106661064",secret:"prod"===BR_ENV?"d6a8a494139d8f0a4ebc981bdb5751a3":"fde7ca80b4bc1e1d912984266f67e36f",accessToken:null,appAccess:null,connectStatus:null,loginCounter:0},j={userID:null,username:null,first_name:null,last_name:null,email:null,gender:null,likes:null,events:null,likesBR:null,location:null,picture:null},k={pageName:null,link:null,likeCount:null,events:[],photos:[]},l=["email","user_activities","friends_activities","user_likes","friends_likes","friends_location","rsvp_event","user_events"],m=function(){function a(){var a=["likes","email","gender","first_name","last_name","username","picture","bio","location","friends"];return d("me?fields="+a.join(","))}function b(){return d("me/events?limit=99999&type=attending&since=0")}function c(a){j.username=a.username||"not given",j.userID=a.id||"not given",j.first_name=a.first_name||"not given",j.last_name=a.last_name||"not given",j.email=a.email||"not given",null===j.events?j.events=a.events||[]:j.events.push(),j.gender=a.gender||"not given",j.picture=a.picture.data.url,"undefined"!=typeof a.likes&&(j.likes=a.likes.data),"undefined"!=typeof a.location&&(j.likes=a.location.name),"undefined"!=typeof a.picture&&(j.likes=a.picture.data.url),"undefined"!=typeof a.friends&&(j.friends=a.friends.data),"undefined"!=typeof a.likes&&e(j.likes)}function e(a){j.likesBR=!1,_.each(a,function(a){j.likesBR=!0})}function f(a){if(!j.events)return!1;for(var b=j.events.length;b--;)if(j.events[b].id==a)return!0}function g(a){for(var b=k.events.length;b--;)if(k.events[b].id==a)return k.events[b]}function h(){var a=["name","likes","events.fields(attending.fields(picture,name))","hours","location","phone","link"];return d("/badracket?fields="+a.join(","))}function l(a){k.pageName=a.name,k.likeCount=a.likes,k.location=a.location,k.phone=a.phone,k.link=a.link,k.hours=a.hours,k.events=a.events.data}function m(){return d("/badracket/albums?fields=id&limit=9999")}function n(a){k.albums=a.data,o(k.albums)}function o(a){window.dfds=[],_.each(a,function(a){var b=new $.Deferred,c="connected"!==br_fb.config.connectStatus?"/photos?fields=images,likes&limit=9999&access_token="+escape(i.appAccess):"/photos?fields=images,likes&limit=9999";FB.api(a.id+c,function(a){_.each(a.data,function(a){var b=a.images[4].source,c=a.images[0].source,d=a.likes?a.likes.data.length:0;k.photos.push({large:c,medium:b,likes:d})}),b.resolve()}),window.dfds.push(b.promise())})}return{isFan:e,isAttending:f,getUser:a,getUserEvents:b,popUser:c,getBR:h,getBR_albums:m,getPhotoURLS:o,popBR:l,popPhotos:n,getEventByID:g}}(),n=function(){function a(a){console.log("response object is ........"),console.log(a);var c=a.status;if($.when(m.getBR()).then(function(a){m.popBR(a),$(window).trigger("fb-page-data-load")}),"connected"===c){var d=a.authResponse.accessToken;i.accessToken=d,i.connectStatus="connected",o.render.authStatus(!0),$.when(m.getUser(),m.getUserEvents()).done(function(a,b){a.events=b.data,m.popUser(a),$(window).trigger("fb-user-data-load"),o.render.user(),o.render.userPicture(),br_mixpanel.setPeople(j),br_player.state.isPlaying&&(br_player.ui.handlers.playClick(),br_player.ui.handlers.playClick())})}else"not_authorized"===c?(o.render.authStatus(!1),i.connectStatus=c,b()):(o.render.authStatus(!1),i.connectStatus=c,b())}function b(){console.log("https://graph.facebook.com/oauth/access_token?client_id="+i.appId+"&redirect_uri=http://badracket.com&client_secret="+i.secret+"&grant_type=client_credentials"),$.ajax({url:"https://graph.facebook.com/oauth/access_token?client_id="+i.appId+"&redirect_uri=http://badracket.com&client_secret="+i.secret+"&grant_type=client_credentials",success:function(a){i.appAccess=a.split("=")[1]}}),o.render.authStatus(!1),i.connectStatus="not_logged_to_fb"}return{globalSetup:a}}(),o=function(){var a={authStatus:function(a){var b=$("html");a?(b.addClass("fb-logged-in"),b.removeClass("fb-logged-out")):(b.addClass("fb-logged-out"),b.removeClass("fb-logged-in")),$(".header-buttons").addClass("loaded")},user:function(){console.log("render login ran"),$(".fb-user-name").text(j.first_name)},userPicture:function(){$(".fb-user-picture").attr("src",j.picture)},rsvpButton:function(a,b){var d=b.closest(".show-rsvp"),e=((new Date).getTime()/1e3).toFixed(),f=b.closest(".padded-mobile-1").find(".show-rsvp").attr("data-fb-id");console.log("now: "+e),console.log("then: "+f);var g="";g=f>e?"You're going!":"You went!",a&&"error"!==a?(d.removeClass("not-attending").addClass("rsvp-attending").find(".text").text(g),$(".show-rsvp").off("click",c.rsvp)):"error"==a&&d.removeClass("not-attending").find(".text").text("Oops! Something went wrong. You might be a Bad Racket admin and can't RSVP")},attending:function(){var a=$(".show-rsvp").attr("data-fb-id"),b=m.getEventByID(a),c=[];if(null===b)return console.log("fuck "),!1;var d=b.attending.data;!function(){var a=0;return _.each(d,function(b){6>a&&c.push(b.name),a++}),a}();var e=d.length-c.length,f=e>0?' and </span> <span class="not-xparent">'+e+" others </span>":"";$(".show-sidebar .attendees .text").html('<span class="not-xparent">'+c.join(", ")+f+" are going.");var g=[];_.each(d,function(a){var b=a.picture.data.url;g.push('<img class="grid" src="'+b+'"/>')}),$(".show-sidebar .attendees .facepile").html(g.join(""))},usersAttending:function(){function a(a,b){for(var c=0;c<b.length;c++)if(b[c]===a)return!0}console.log("users attending raaaaaaaaaaaannnnnnnn");var b=$(".show-rsvp").data("fb-id"),c=m.getEventByID(b);if("undefined"==typeof c)return!1;var d=c.attending.data,e=_.pluck(j.friends,"id"),f=[],g=[];console.log("this is the attendees:"),console.log(d),d=_.sortBy(d,function(b){return a(b.id,e)});for(var h=function(){var b=0;return _.each(d,function(c){a(c.id,e)&&(f.length<6&&f.push(c),c.friend=!0,b++)}),b}(),i=0;i<f.length;i++)d[i].name!==j.first_name+" "+j.last_name&&g.push(d[i].name);var k="",l="",n=0;m.isAttending(b)&&(console.log("yep"),k=" also ",l="You, ",n=1);var o=d.length-f.length-n,p=o>0?' and  <span class="not-xparent">'+o+" others </span>":"";$(".show-sidebar .attendees .text").html('<span class="not-xparent">'+g.join(", ")+"</span>"+p+" are going.");var q=[];console.log("the list of 4 attendees"),console.log(d),_.each(d,function(a){if(a.friend||a.name===j.first_name+" "+j.last_name||6>h){var b=a.picture.data.url;q.push('<img class="grid" src="'+b+'"/>')}}),$(".show-sidebar .attendees .facepile").html(q.join(""))},renderPhotos:function(){$.when.apply(null,window.dfds).done(function(){k.sortedPhotos=_.sortBy(k.photos,function(a){return-a.likes});for(var a=[],b=0;95>b;b++)a.push('<div class="grid padded"><div class="lazyload fade ratio-4-3" data-src="'+k.sortedPhotos[b].medium+'"></div></div>');$(".photos-container").html(a.join("\n")),badracket.lazyLoadImg("render photos")})},videos:function(){var a=$("#video-container"),b=[];_.each(k.videos,function(a){var c=a.thumbnail_large,d=a.title.split(":")[0],e=a.title.split("-")[1],f=a.id,g=['<div class="grid padded">','<div class="playable video" data-id="'+f+'">','<div class="play"></div> ','<div class="lazyload fade ratio-16-9" data-src="'+c+'">',"</div>","</div>",'<div class="album-meta">','<div class="album-title">'+d+"</div>",'<div class="artist-name">'+e+"</div>","</div>","</div>"].join("");b.push(g)}),a.html(b),d.video(),badracket.lazyLoadImg("vimeo inject - all")},videosHome:function(){for(var a=$("#video-container"),b=[],c=0;4>c;c++){var e=k.videos[c],f=e.thumbnail_large,g=e.title.split(":")[0],h=e.title.split("-")[1],i=e.id,j=['<div class="grid padded">','<a href="'+br_state.urls.videos+'" class="dJAX_internal">','<div class="playable video" data-id="'+i+'">','<div class="play"></div> ','<div class="lazyload fade ratio-16-9" data-src="'+f+'"></div>',"</div>",'<div class="album-meta">','<div class="album-title">'+g+"</div>",'<div class="artist-name">'+h+"</div>","</div>","</a>","</div>"].join("");b.push(j)}a.html(b),d.videoHome(),badracket.lazyLoadImg("vimeo inject - home")}},b={bind:function(){function a(){var a=$(".vimeo-container");setTimeout(function(){a.removeClass("loading")},500),br_mixpanel.track("Video started"),mixpanel.people.increment("Videos started",1),$(window).trigger("vimeo-play-event")}function b(){$(window).trigger("vimeo-pause-event")}function c(){mixpanel.people.increment("Videos finished",1),br_mixpanel.track("Video ended"),$(".next").find(".video").click()}var d=$("#vimeo-player")[0],e=$f(d);e.addEvent("ready",function(){e.addEvent("play",a),e.addEvent("pause",b),e.addEvent("finish",c)}),$(window).on("sm2-play-event",function(){e.api("pause")})}},c={login:function(){f(),br_mixpanel.track("FB Login Clicked")},logout:function(){g()},videoHomeClick:function(){var a=$(this).data("id");console.log("vid home click ran biiiiiiiiiiiiiiiiiooooooooooooch"),$(window).on("djaxLoad",function(){$('[data-id="'+a+'"]').click(),console.log($('[data-id="'+a+'"]'))}),br_mixpanel.track("Click: video")},videoClick:function(){$(window).off("sm2-play-event");var a=$(this);$("html, body").animate({scrollTop:0},"slow");var c=a.data("id"),d=$(".vimeo-container");$(".grid").removeClass("playing next"),a.closest(".grid").addClass("playing").next().addClass("next");var e=.5*$(".main-content").width();d.addClass("loading").css("height",e),d.find(".iframe-wrap").html('<iframe style="visibility:hidden;" onload="this.style.visibility=\'visible\';" id="vimeo-player" src="http://player.vimeo.com/video/'+c+'?api=1&autoplay=true&player_id=vimeo-player"></iframe>'),b.bind(),d.fitVids(),br_mixpanel.track("Click: video")},rsvp:function(b){function c(a){var b=!1;return _.each(j.events,function(c){c.id==a&&(console.log("is already going"),b=!0)}),b}function d(){console.log("attend called"),FB.api("/"+g+"/attending","post",function(b){e.removeClass("transparent"),console.log(b),b.error?a.rsvpButton("error",e):(a.rsvpButton(!0,e),null===j.events&&(j.events=[]),c(g)||j.events.push(m.getEventByID(g)))})}var e=$(b.target).closest(".show-rsvp");e.addClass("transparent");var g=e.data("fb-id");console.log(g),br_mixpanel.track("RSVP click"),"connected"!==i.connectStatus?f(d):d()}},d={login:function(){$(".facebook .login").on("click",c.login)},logout:function(){$(".facebook .logout").on("click",c.logout)},rsvp:function(){s.bd.on({click:function(a){c.rsvp(a)}},".show-rsvp")},video:function(){$(".video").on("click",c.videoClick)},videoHome:function(){$('[data-view="home"]').find(".video").on("click",c.videoHomeClick)},bindAll:function(){this.login(),this.logout(),this.rsvp()},unBindAll:function(){$(".facebook .login").off("click",c.login),$(".facebook .logout").off("click",c.logout),$(".show-rsvp").off("click",c.rsvp)}};return{render:a,bindUI:d,vimeo:b}}();return{config:i,init:h,login:f,logout:g,fbEnsureInit:a,user_do_or_wait:b,page_do_or_wait:c,fetch:m,user:j,BR:k,UI:o}}();br_fb.UI.bindUI.bindAll();