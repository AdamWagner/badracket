function updateView(){return function(a,b){br_state.viewSet(b)}}function doMoreStuff(){console.log("do more stuff ran");var a=br_player.history.album.random(),b=br_player.albumData.sampleSong(a);br_player.history.update(a,b),br_player.ui.render.init(a,b),br_player.ui.bindui.album(),br_player.ui.bindui.song(),br_player.ui.bindui.slider(),br_player.ui.bindui.play(),br_player.ui.bindui.next(),br_player.ui.bindui.buyAlbum(),br_player.ui.bindui.buyAlbumDetail(),br_player.ui.bindui.buyAlbumHover(),br_player.ui.bindui.previous()}var br_sm2=function(){function a(a){console.log("setting up sm2 ********"),soundManager.setup(g),soundManager.onready(function(){a()})}function b(a){var b=a.sampleTrack?badracket.utils.stringToTime("0:30"):badracket.utils.stringToTime(br_player.state.currSong.duration),c=a.position,d=br_player.state.isSliding;playbarWidth=(100*(c/b)).toFixed(2)+"%",d||br_player.state.currSong.sm2_obj!==a||(br_player.ui.el.progressBar.css("width",playbarWidth),br_player.ui.el.progressTime.text(badracket.utils.msToTime(c)))}function c(a){console.log("on finish ran"),a.setPosition(0),br_player.ui.handlers.nextPrev("next"),br_mixpanel.track("Song Ended",{songUrl:a.url,duration:badracket.utils.msToTime(a.duration)}),mixpanel.people.increment("Songs finished",1)}function d(a,d){return console.log("create sound ran"),mixpanel.people.increment("Songs started",1),br_mixpanel.track("Song started"),d?soundManager.createSound({id:"brSound"+h++,url:a.songUrl,autoLoad:!0}):soundManager.createSound({id:"brSound"+h++,url:a.songUrl,autoLoad:!0,onplay:function(){br_player.state.isPlaying=!0,$(window).trigger("sm2-play-event")},onresume:function(){br_player.state.isPlaying=!0,$(window).trigger("sm2-play-event")},onpause:function(){br_player.state.isPlaying=!1},onstop:function(){br_player.state.isPlaying=!1},whileplaying:function(){b(this)},onfinish:function(){c(this)}})}function e(){var a=br_player.history.song.lastPlayed();"undefined"!=typeof a&&"sm2_obj"in a&&a.sm2_obj.loaded===!1&&a.sm2_obj.unload()}function f(a,b,c){console.log("play-pause ran"),e(),"sm2_obj"in a||(a.sm2_obj=d(a,c)),0!=a.isSampleTrack||$("html").hasClass("fb-logged-in")?(a.sm2_obj.sampleTrack=!1,br_player.logic.remove30SecondListener(a)):(br_player.logic.attach30SecondListener(a),a.sm2_obj.sampleTrack=!0),br_player.ui.render.sampleState(a),b?a.sm2_obj.pause():a.sm2_obj.togglePause()}var g={url:"prod"===BR_ENV?s.domain+"swf":"/brv5-prod/swf",flashVersion:9,debugMode:!1,flashPollingInterval:125,html5PollingInterval:125,useHighPerformance:!0},h=0;return{setup:a,createSound:d,playPause:f,onFinish:c}}(),br_inline_player=function(){function a(a){var c;return _.each(b,function(b){b.songUrl===a&&(c=b)}),c}var b=[],c={playClick:function(){console.log("inline-play-click-bound"),s.bd.on({click:function(a){d.playClick(a)}},".inline-play-pause")}},d={playClick:function(c){var d=$(c.target).closest(".inline-player"),e=d.data("song-url"),f=a(e),g=d.find(".inline-play-pause");if($(window).trigger("vimeo-play-event",e),f){f.sm2_obj.togglePause();var h=f.sm2_obj.paused?"m":"n";g.attr("data-icon",h)}else{var i={songUrl:e};b.push(i),br_sm2.playPause(i,!1,!0),g.attr("data-icon","n"),$(window).on("sm2-play-event vimeo-play-event",function(a,b){return b===i.songUrl?!1:(i.sm2_obj.pause(),g.attr("data-icon","m"),void 0)})}}};return{bindUI:c}}();br_inline_player.bindUI.playClick();var br_player=function(){var a={isPreviewSong:!1,isSliding:!1,isPlaying:!1,currSong:null,currAlbum:null},b=function(){var b={playerWrapper:$(".audio-player-wrapper"),player:$(".audio-player"),song:$(".audio-player .song"),artist:$(".audio-player .artist"),albumLink:$(".audio-player .view-full-album"),progressBar:$(".audio-player .progress-bar"),progressTime:$(".audio-player .progress-time"),currentTrack:$(".audio-player .current-track"),totalTracks:$(".audio-player .total-tracks"),slider:$(".slider"),playButton:$(".play-pause"),prevButton:$(".previous"),nextButton:$(".next"),ctaWrap:$(".support-band"),ctaButton:$(".support-band-button")},f={play:"m",pause:"n",speaker:"s"},g={init:function(a,c){if(b.player.addClass("ready"),"show"===a.kind){b.artist.html(c.artist);var d=new Date(a.date.split(" ")[0]),e=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1),f=date("M j",e);b.albumLink.find(".show").text("Playing "+f+": ").show(),b.albumLink.find(".target").text("view show"),b.albumLink.find(".track-count").hide(),b.ctaWrap.attr("data-toggle","none"),b.ctaWrap.attr("href",a.albumUrl),b.ctaButton.text("Get Tickets"),b.ctaButton.removeClass("get-album")}else 1==c.isSampleTrack||$("html").hasClass("fb-logged-in")?b.player.removeClass("preview-song"):b.player.addClass("preview-song"),b.albumLink.find(".show").hide(),b.artist.html(a.artist),b.albumLink.find(".track-count").show(),b.albumLink.find(".target").text("View album"),b.ctaWrap.attr("data-toggle","modal"),b.ctaWrap.attr("href","#buy-album-form"),b.ctaButton.text("Get Album"),b.ctaButton.addClass("get-album");b.song.html(c.songTitle),b.progressBar.css("width","0%"),b.progressTime.html(c.duration),b.albumLink.attr("href",a.albumUrl),b.currentTrack.html(parseInt(c.trackNumber,10)),b.totalTracks.html(a.tracks.length)},playState:function(){var c=a.isPlaying?f.pause:f.play;b.playButton.attr("data-icon",c)},sampleState:function(a){1==a.isSampleTrack||$("html").hasClass("fb-logged-in")?b.player.removeClass("preview-song"):b.player.addClass("preview-song")},updateTime:function(a){b.progressTime.html(a)}},h={playClick:function(){br_player.logic.targetSong(a.currAlbum,a.currSong),g.playState(),br_mixpanel.track("Click: Play / Pause")},albumClick:function(a){var b=$(a.target);if("album-detail"===br_state.viewGet()||b.closest("a").hasClass("link-to-album"))return!1;a.preventDefault(),a.stopPropagation();var e=b.closest(".album").attr("data-album-title"),f=d.getAlbumByName(e),g=d.sampleSong(f);c.targetSong(f,g),br_mixpanel.track("Click: Album",{albumTitle:e})},songClick:function(a){var b=$("[data-album-title]").attr("data-album-title"),e=d.getAlbumByName(b),f=parseInt($(a.target).closest(".song").attr("data-track-number"),10)-1,g=e.tracks[f];c.targetSong(e,g),br_mixpanel.track("Click: Song",{songTitle:g.songTitle})},nextPrev:function(a){var b;"next"===a?(b=e.song.next(),c.targetSong(b[0],b[1])):(previousAlbumSong=e.song.previous(),c.targetSong(previousAlbumSong[0],previousAlbumSong[1])),br_mixpanel.track("Click: Next / Previous")},buyAlbum:function(a){a.preventDefault();var b=br_player.state.currAlbum,c=b.albumName,d=b.zipFile,e="$"+b.price+".00",f=(100*b.price,b.artist),g=b.coverUrl;0===parseInt(b.price,10)?badracket.setupDownloadForm(g,c,f,e,d):badracket.setupPayForm(g,c,f,e,d),br_mixpanel.track("Click: Buy Album")},buyAlbumHover:function(){function a(){console.log("yep"),s.bd.off("hover",".support-band-button")}badracket.loader.require([badracket_theme_path+"/js/prod/payments-min.js"],a())},buyAlbumDetail:function(a){a.preventDefault();var b=$("[data-album-title]").attr("data-album-title"),c=br_player.albumData.getAlbumByName(b),d=c.albumName,e=c.zipFile,f="$"+c.price+".00",g=(100*c.price,c.artist),h=c.coverUrl;console.log(c),0===parseInt(c.price,10)?badracket.setupDownloadForm(h,d,g,f,e):badracket.setupPayForm(h,d,g,f,e),br_mixpanel.track("Click: Buy Album")},whileSliding:function(a,c){b.progressBar.css("width",c.value+"%")},slideStart:function(){a.isSliding=!0,br_mixpanel.track("Drag: Progress bar")},slideStop:function(b,c){a.isSliding=!1;var d;d=0!=br_player.state.currSong.isSampleTrack||$("html").hasClass("fb-logged-in")?c.value/100*badracket.utils.stringToTime(a.currSong.duration):3e4*(c.value/100),a.currSong.sm2_obj.setPosition(d)},rewind:function(){s=br_player.history.song.current(),s.sm2_obj&&s.sm2_obj.setPosition(0)}},i={play:function(){s.bd.on({click:function(){h.playClick()}},".play-pause")},next:function(){s.bd.on({click:function(){h.nextPrev("next")}},".audio-player .next")},previous:function(){s.bd.on({click:function(){h.nextPrev("prev")}},".previous")},album:function(){s.bd.on({click:function(a){h.albumClick(a)}},".album")},song:function(){s.bd.on({click:function(a){h.songClick(a)}},".song")},buyAlbum:function(){s.bd.on({click:function(a){h.buyAlbum(a)}},".get-album")},buyAlbumDetail:function(){s.bd.on({click:function(a){h.buyAlbumDetail(a)}},".buy-album-detail")},buyAlbumHover:function(){s.bd.on({hover:function(a){h.buyAlbumHover(a)}},".support-band-button, .buy-album-detail")},slider:function(){b.slider.slider({step:.01,slide:function(a,b){h.whileSliding(a,b)},start:function(){h.slideStart()},stop:function(a,b){h.slideStop(a,b)}})}};return{el:b,handlers:h,bindui:i,render:g}}(),c=function(){function c(a,b,c){var d=$('.song[data-track-number="'+b.trackNumber+'"]'),e=$('.album[data-album-title="'+a.albumName+'"]'),f=br_state.viewGet();console.log(f),"album-detail"===f||"show-detail"===f?$("[data-album-title]").attr("data-album-title")===a.albumName&&("toggle"===c?d.toggleClass("song-playing"):d.removeClass("song-playing")):"toggle"===c?e.toggleClass("playing"):e.removeClass("playing")}function d(d,f,g){f.songTitle!==a.currSong.songTitle&&("undefined"!=typeof a.currSong.sm2_obj&&a.currSong.sm2_obj.setPosition(0),b.render.init(d,f),c(a.currAlbum,a.currSong,"clear"),a.isPlaying&&a.currSong.sm2_obj.stop(),e.update(d,f)),c(d,f,"toggle"),br_sm2.playPause(f,g),b.render.playState()}function f(a){var b=a.sm2_obj;b.onPosition(26e3,function(){h(b)}),b.onPosition(3e4,function(){br_sm2.onFinish(a.sm2_obj)})}function g(a){var b=a.sm2_obj;b.clearOnPosition(26e3),b.clearOnPosition(3e4)}function h(a){var b=a.volume;return 0===b?(setTimeout(function(){a.setVolume(100)},1e3),!1):(a.setVolume(Math.min(100,b-1)),setTimeout(function(){h(a)},40),void 0)}return{targetSong:d,attach30SecondListener:f,remove30SecondListener:g}}(),d=function(){function a(a){e=e.concat(a),d=e.length}function b(a){for(var b=d;b--;)if(e[b].albumName===a)return e[b]}function c(a){for(var b=a.tracks,c=0;c<b.length;c++)if(1==parseInt(b[c].isSampleTrack,10))return b[c]}var d,e=[];return{getAlbumByName:b,sampleSong:c,set:a,get:function(){return e}}}(),e=function(){function b(a,b){h=d.get().indexOf(a),i=a.tracks.indexOf(b),j.push([h,i]),f(a,b),console.log("updatehistory ran")}function c(){return j}function f(b,c){console.log(a),a.currAlbum=b,a.currSong=c}function g(){return j.length}var h,i,j=[],k=function(){function a(){return d.get()[h]}function b(){return d.get()[h+1]}function c(){return d.get()[h-1]}function e(){var a=br_player.albumData.get();return a[Math.round(Math.random(0,a.length))]}return{current:a,next:b,previous:c,random:e}}(),l=function(){function b(){return d.get()[h].tracks[i]}function c(){l=d.get(),m=l.length,n=a.currAlbum.tracks.length,o=e.album.next(),p=e.album.previous()}function f(){c();var b=i+1;if(b>=n){if(h>=m-1){var d=l[0],e=d.tracks[0];return[d,e]}var f=o.tracks[0];return[o,f]}return nextSong=a.currAlbum.tracks[b],[a.currAlbum,nextSong]}function g(){c();var b=i-1;if(0>b){if(0>=h){var d=l[m-1],e=d.tracks[d.tracks.length-1];return[d,e]}var f=p.tracks[p.tracks.length-1];return[p,f]}return previousSong=a.currAlbum.tracks[b],[a.currAlbum,previousSong]}function k(){var a,b,c=j[j.length-2];return"undefined"!=typeof c?(a=c[0],b=c[1],d.get()[a].tracks[b]):void 0}var l,m,n,o,p;return{current:b,next:f,previous:g,lastPlayed:k}}();return{get:c,update:b,length:g,album:k,song:l}}();return{state:a,ui:b,logic:c,albumData:d,history:e}}();$.subscribe("/view/change",updateView("/view/change"));var init=function(){function a(){console.log("trying to load sm"),"undefined"!=typeof soundManager?br_sm2.setup(b):setTimeout(function(){a()},125)}function b(){console.log("Soundmanager ready"),e.sm=!0,$(window).on("vimeo-play-event",function(){var a=br_player.state.currAlbum,b=br_player.state.currSong;br_player.logic.targetSong(a,b,!0)}),d()}function c(a){console.log("Album data ready"),e[a]=!0,d()}function d(){e.sm&&e.album&&e.show&&(console.log("everything is loaded"),doMoreStuff())}var e={sm:!1,album:!1,show:!1};return{loadSM:a,dataReady:c,readyState:e,init:init}}();init.loadSM();