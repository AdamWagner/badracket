var br_fb=function(){function e(t){if(!window.FB||!f.accessToken&&!f.appAccess){console.log("ensure init still running");f.loginCounter++;f.loginCounter<50&&setTimeout(function(){e(t)},150)}else t&&t()}function t(e){br_fb.user.events!==null?e():$(window).on("fb-user-data-load",function(){e()})}function n(e){br_fb.BR.events.length>0?e():$(window).on("fb-page-data-load",function(){e()})}function r(t){var n=new $.Deferred,r=function(){if(f.connectStatus==="connected"){FB.api(t,function(e){n.resolve(e)});console.log("call fb called with this path "+t)}else{t=t+"&access_token="+escape(f.appAccess);console.log("call fb called with this path "+t);FB.api(t,function(e){console.log(e);n.resolve(e)})}};e(r);return n.promise()}function i(){FB.getLoginStatus(function(e){d.globalSetup(e)})}function o(e){FB.login(function(t){i(t);e&&e()},{scope:h.join(",")})}function u(){FB.logout(function(e){})}function a(){FB.init({appId:f.appId,channelUrl:"//WWW.BADRACKET.COM/channel.html",status:!0,cookie:!0,xfbml:!0});i()}var f={appId:BR_ENV==="prod"?"182655285084916":"500547106661064",secret:BR_ENV==="prod"?"d6a8a494139d8f0a4ebc981bdb5751a3":"fde7ca80b4bc1e1d912984266f67e36f",accessToken:null,appAccess:null,connectStatus:null,loginCounter:0},l={userID:null,username:null,first_name:null,last_name:null,email:null,gender:null,likes:null,events:null,likesBR:null,location:null,picture:null},c={pageName:null,link:null,likeCount:null,events:[],photos:[]},h=["email","user_activities","friends_activities","user_likes","friends_likes","friends_location","rsvp_event","user_events"],p=function(){function e(){var e=["likes","email","gender","first_name","last_name","username","picture","bio","location","friends"];return r("me?fields="+e.join(","))}function t(){return r("me/events?limit=99999&type=attending&since=0")}function n(e){function t(e){var t=!1;_.each(l.events,function(n){if(n.id==e){console.log("is already going");t=!0}});return t}l.username=e.username||"not given";l.userID=e.id||"not given";l.first_name=e.first_name||"not given";l.last_name=e.last_name||"not given";l.email=e.email||"not given";l.events===null?l.events=e.events||[]:l.events.push();l.gender=e.gender||"not given";l.picture=e.picture.data.url;typeof e.likes!="undefined"&&(l.likes=e.likes.data);typeof e.location!="undefined"&&(l.likes=e.location.name);typeof e.picture!="undefined"&&(l.likes=e.picture.data.url);typeof e.friends!="undefined"&&(l.likes=e.friends.data);typeof e.likes!="undefined"&&i(l.likes)}function i(e){l.likesBR=!1;_.each(e,function(e){if(e.name===c.pageName||"Bad Racket Recording Studio")l.likesBR=!0})}function s(e){if(!l.events)return!1;for(var t=l.events.length;t--;)if(l.events[t].id==e)return!0}function o(e){for(var t=c.events.length;t--;)if(c.events[t].id==e)return c.events[t]}function u(){var e=["name","likes","events.fields(attending.fields(picture,name))","hours","location","phone","link"];return r("/badracket?fields="+e.join(","))}function a(e){c.pageName=e.name;c.likeCount=e.likes;c.location=e.location;c.phone=e.phone;c.link=e.link;c.hours=e.hours;c.events=e.events.data}function h(){return r("/badracket/albums?fields=id&limit=9999")}function p(e){c.albums=e.data;d(c.albums)}function d(e){window.dfds=[];_.each(e,function(e){var t=new $.Deferred,n=br_fb.config.connectStatus!=="connected"?"/photos?fields=images,likes&limit=9999&access_token="+escape(f.appAccess):"/photos?fields=images,likes&limit=9999";FB.api(e.id+n,function(e){_.each(e.data,function(e){var t=e.images[4].source,n=e.images[0].source,r=e.likes?e.likes.data.length:0;c.photos.push({large:n,medium:t,likes:r})});t.resolve()});window.dfds.push(t.promise())})}return{isFan:i,isAttending:s,getUser:e,getUserEvents:t,popUser:n,getBR:u,getBR_albums:h,getPhotoURLS:d,popBR:a,popPhotos:p,getEventByID:o}}(),d=function(){function e(e){console.log("response object is ........");console.log(e);var n=e.status;$.when(p.getBR()).then(function(e){p.popBR(e);$(window).trigger("fb-page-data-load")});if(n==="connected"){var r=e.authResponse.accessToken;f.accessToken=r;f.connectStatus="connected";v.render.authStatus(!0);$.when(p.getUser(),p.getUserEvents()).done(function(e,t){e.events=t.data;p.popUser(e);$(window).trigger("fb-user-data-load");v.render.user();v.render.userPicture();br_mixpanel.setPeople(l);if(br_player.state.isPlaying){br_player.ui.handlers.playClick();br_player.ui.handlers.playClick()}})}else if(n==="not_authorized"){v.render.authStatus(!1);f.connectStatus=n;t()}else{v.render.authStatus(!1);f.connectStatus=n;t()}}function t(){console.log("https://graph.facebook.com/oauth/access_token?client_id="+f.appId+"&redirect_uri=http://localhost:8888/sites/brv5/wp-br/&client_secret="+f.secret+"&grant_type=client_credentials");$.ajax({url:"https://graph.facebook.com/oauth/access_token?client_id="+f.appId+"&redirect_uri=http://localhost:8888/sites/brv5/wp-br/&client_secret="+f.secret+"&grant_type=client_credentials",success:function(e){f.appAccess=e.split("=")[1]}});v.render.authStatus(!1);f.connectStatus="not_logged_to_fb"}return{globalSetup:e}}(),v=function(){var e={authStatus:function(e){var t=$("html");if(e){t.addClass("fb-logged-in");t.removeClass("fb-logged-out")}else{t.addClass("fb-logged-out");t.removeClass("fb-logged-in")}$(".header-buttons").addClass("loaded")},user:function(){console.log("render login ran");$(".fb-user-name").text(l.first_name)},userPicture:function(){$(".fb-user-picture").attr("src",l.picture)},rsvpButton:function(e,t){var r=t.closest(".show-rsvp"),i=((new Date).getTime()/1e3).toFixed(),s=t.closest(".padded-mobile-1").find(".show-rsvp").attr("data-fb-id");console.log("now: "+i);console.log("then: "+s);var o="";s>i?o="You're going!":o="You went!";if(e&&e!=="error"){r.removeClass("not-attending").addClass("rsvp-attending").find(".text").text(o);$(".show-rsvp").off("click",n.rsvp)}else e=="error"&&r.removeClass("not-attending").find(".text").text("Oops! Something went wrong. You might be a Bad Racket admin and can't RSVP")},attending:function(e){var t=$(".show-rsvp").attr("data-fb-id"),n=p.getEventByID(t),r=[];if(n===null){console.log("fuck ");return!1}var i=n.attending.data,s=function(){var e=0;_.each(i,function(t){e<6&&r.push(t.name);e++});return e}(),o=i.length-r.length,u=o>0?' and </span> <span class="not-xparent">'+o+" others </span>":"";$(".show-sidebar .attendees .text").html('<span class="not-xparent">'+r.join(", ")+u+" are going.");var a=[];_.each(i,function(e){var t=e.picture.data.url;a.push('<img class="grid" src="'+t+'"/>')});$(".show-sidebar .attendees .facepile").html(a.join(""))},usersAttending:function(){function e(e,t){for(var n=0;n<t.length;n++)if(t[n]===e)return!0}console.log("users attending raaaaaaaaaaaannnnnnnn");var t=$(".show-rsvp").data("fb-id"),n=p.getEventByID(t);if(typeof n=="undefined")return!1;var r=n.attending.data,i=_.pluck(l.friends,"id"),s=[],o=[];console.log("this is the attendees:");console.log(r);r=_.sortBy(r,function(t){return e(t.id,i)});var u=function(){var t=0;_.each(r,function(n){if(e(n.id,i)){s.length<6&&s.push(n);n.friend=!0;t++}});return t}();for(var a=0;a<s.length;a++)r[a].name!==l.first_name+" "+l.last_name&&o.push(r[a].name);var f="",c="",h=0;if(p.isAttending(t)){console.log("yep");f=" also ";c="You, ";h=1}var d=r.length-s.length-h,v=d>0?' and  <span class="not-xparent">'+d+" others </span>":"";$(".show-sidebar .attendees .text").html('<span class="not-xparent">'+o.join(", ")+"</span>"+v+" are going.");var m=[];console.log("the list of 4 attendees");console.log(r);_.each(r,function(e){if(e.friend||e.name===l.first_name+" "+l.last_name||u<6){var t=e.picture.data.url;m.push('<img class="grid" src="'+t+'"/>')}});$(".show-sidebar .attendees .facepile").html(m.join(""))},renderPhotos:function(){$.when.apply(null,window.dfds).done(function(e){c.sortedPhotos=_.sortBy(c.photos,function(e){return-e.likes});var t=[];for(var n=0;n<95;n++)t.push('<div class="grid padded"><div class="lazyload fade ratio-4-3" data-src="'+c.sortedPhotos[n].medium+'"></div></div>');$(".photos-container").html(t.join("\n"));badracket.lazyLoadImg("render photos")})},videos:function(){var e=$("#video-container"),t=[];_.each(c.videos,function(e){var n=e.thumbnail_large,r=e.title.split(":")[0],i=e.title.split("-")[1],s=e.id,o=['<div class="grid padded">','<div class="playable video" data-id="'+s+'">','<div class="play"></div> ','<div class="lazyload fade ratio-16-9" data-src="'+n+'">',"</div>","</div>",'<div class="album-meta">','<div class="album-title">'+r+"</div>",'<div class="artist-name">'+i+"</div>","</div>","</div>"].join("");t.push(o)});e.html(t);r.video();badracket.lazyLoadImg("vimeo inject - all")},videosHome:function(){var e=$("#video-container"),t=[];for(var n=0;n<4;n++){var i=c.videos[n],s=i.thumbnail_large,o=i.title.split(":")[0],u=i.title.split("-")[1],a=i.id,f=['<div class="grid padded">','<a href="'+br_state.urls.videos+'" class="dJAX_internal">','<div class="playable video" data-id="'+a+'">','<div class="play"></div> ','<div class="lazyload fade ratio-16-9" data-src="'+s+'"></div>',"</div>",'<div class="album-meta">','<div class="album-title">'+o+"</div>",'<div class="artist-name">'+u+"</div>","</div>","</a>","</div>"].join("");t.push(f)}e.html(t);r.videoHome();badracket.lazyLoadImg("vimeo inject - home")}},t={bind:function(){function e(e){var t=$(".vimeo-container");setTimeout(function(){t.removeClass("loading")},500);br_mixpanel.track("Video started");mixpanel.people.increment("Videos started",1);$(window).trigger("vimeo-play-event")}function t(e){$(window).trigger("vimeo-pause-event")}function n(e){mixpanel.people.increment("Videos finished",1);br_mixpanel.track("Video ended");$(".next").find(".video").click()}var r=$("#vimeo-player")[0],i=$f(r);i.addEvent("ready",function(){i.addEvent("play",e);i.addEvent("pause",t);i.addEvent("finish",n)});$(window).on("sm2-play-event",function(){i.api("pause")})}},n={login:function(){o()},logout:function(){u()},videoHomeClick:function(){var e=$(this).data("id");console.log("vid home click ran biiiiiiiiiiiiiiiiiooooooooooooch");$(window).on("djaxLoad",function(t,n){$('[data-id="'+e+'"]').click();console.log($('[data-id="'+e+'"]'))});br_mixpanel.track("Click: video")},videoClick:function(){$(window).off("sm2-play-event");var e=$(this);$("html, body").animate({scrollTop:0},"slow");var n=e.data("id"),r=$(".vimeo-container");$(".grid").removeClass("playing next");e.closest(".grid").addClass("playing").next().addClass("next");var i=$(".main-content").width()*.5;r.addClass("loading").css("height",i);r.find(".iframe-wrap").html('<iframe style="visibility:hidden;" onload="this.style.visibility=\'visible\';" id="vimeo-player" src="http://player.vimeo.com/video/'+n+'?api=1&autoplay=true&player_id=vimeo-player"></iframe>');t.bind();r.fitVids();br_mixpanel.track("Click: video")},rsvp:function(t){function n(e){var t=!1;_.each(l.events,function(n){if(n.id==e){console.log("is already going");t=!0}});return t}function r(){console.log("attend called");FB.api("/"+s+"/attending","post",function(t){i.removeClass("transparent");console.log(t);if(t.error)e.rsvpButton("error",i);else{e.rsvpButton(!0,i);l.events===null&&(l.events=[]);n(s)||l.events.push(p.getEventByID(s))}})}var i=$(t.target).closest(".show-rsvp");i.addClass("transparent");var s=i.data("fb-id");console.log(s);f.connectStatus!=="connected"?o(r):r()}},r={login:function(){$(".facebook .login").on("click",n.login)},logout:function(){$(".facebook .logout").on("click",n.logout)},rsvp:function(){s.bd.on({click:function(e){n.rsvp(e)}},".show-rsvp")},video:function(){$(".video").on("click",n.videoClick)},videoHome:function(){$('[data-view="home"]').find(".video").on("click",n.videoHomeClick)},bindAll:function(){this.login();this.logout();this.rsvp()},unBindAll:function(){$(".facebook .login").off("click",n.login);$(".facebook .logout").off("click",n.logout);$(".show-rsvp").off("click",n.rsvp)}};return{render:e,bindUI:r,vimeo:t}}();return{config:f,init:a,login:o,logout:u,fbEnsureInit:e,user_do_or_wait:t,page_do_or_wait:n,fetch:p,user:l,BR:c,UI:v}}();br_fb.UI.bindUI.bindAll();